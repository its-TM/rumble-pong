<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pong Game</title>
    <style>
      html, body {
        margin: 0;
        padding: 0;
      }
      canvas {
        display: block;
      }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/addons/p5.sound.min.js"></script>
  </head>

  <body>
    <script>
      let leftscore = 0;
      let rightscore = 0;
      let puck;
      let left;
      let right;
      let ding;

      class Paddle {
          constructor(isLeft) {
              this.y = height/2;
              this.w = 20;
              this.h = 100;
              this.ychange = 0;
              
              if (isLeft) {
                  this.x = this.w;
              } else {
                  this.x = width - this.w;
              }
          }
          
          update() {
              this.y += this.ychange;
              this.y = constrain(this.y, this.h/2, height-this.h/2);
          }
          
          move(steps) {
              this.ychange = steps;
          }
          
          show() {
              fill(255);
              rectMode(CENTER);
              rect(this.x, this.y, this.w, this.h);
          }
      }

      class Puck {
          constructor() {
              this.x = width/2;
              this.y = height/2;
              this.xspeed = 0;
              this.yspeed = 0;
              this.r = 12;
              
              this.reset();
          }
          
          checkPaddleLeft(p) {
              if (this.y - this.r < p.y + p.h/2 &&
                  this.y + this.r > p.y - p.h/2 &&
                  this.x - this.r < p.x + p.w/2) {
                      
                  if (this.x > p.x) {
                      let diff = this.y - (p.y - p.h/2);
                      let rad = radians(45);
                      let angle = map(diff, 0, p.h, -rad, rad);
                      this.xspeed = 5 * cos(angle);
                      this.yspeed = 5 * sin(angle);
                      this.x = p.x + p.w/2 + this.r;
                  }
              }
          }
          
          checkPaddleRight(p) {
              if (this.y - this.r < p.y + p.h/2 &&
                  this.y + this.r > p.y - p.h/2 &&
                  this.x + this.r > p.x - p.w/2) {
                      
                  if (this.x < p.x) {
                      let diff = this.y - (p.y - p.h/2);
                      let angle = map(diff, 0, p.h, radians(225), radians(135));
                      this.xspeed = 5 * cos(angle);
                      this.yspeed = 5 * sin(angle);
                      this.x = p.x - p.w/2 - this.r;
                  }
              }
          }
          
          update() {
              this.x += this.xspeed;
              this.y += this.yspeed;
          }
          
          reset() {
              this.x = width/2;
              this.y = height/2;
              let angle = random(-PI/4, PI/4);
              this.xspeed = 5 * Math.cos(angle);
              this.yspeed = 5 * Math.sin(angle);
              
              if (random(1) < 0.5) {
                  this.xspeed *= -1;
              }
          }
          
          edges() {
              if (this.y < 0 || this.y > height) {
                  this.yspeed *= -1;
              }
              
              if (this.x - this.r > width) {
                  // Play sound with error handling
                  if (ding && ding.isLoaded()) {
                      ding.play();
                  }
                  leftscore++;
                  this.reset();
              }
              
              if (this.x + this.r < 0) {
                  // Play sound with error handling
                  if (ding && ding.isLoaded()) {
                      ding.play();
                  }
                  rightscore++;
                  this.reset();
              }
          }
          
          show() {
              fill(255);
              ellipse(this.x, this.y, this.r*2);
          }
      }

      function setup() {
          createCanvas(600, 400);
          soundFormats('mp3', 'ogg');
          // Load sound with error handling
          ding = loadSound('ding.mp3', 
              () => console.log("Sound loaded successfully"),
              () => console.log("Sound failed to load")
          );
          
          puck = new Puck();
          left = new Paddle(true);
          right = new Paddle(false);
      }

      function draw() {
          background(0);
          
          puck.checkPaddleRight(right);
          puck.checkPaddleLeft(left);

          left.show();
          right.show();
          left.update();
          right.update();
          
          puck.update();
          puck.edges();
          puck.show();
          
          fill(255);
          textSize(32);
          text(leftscore, 32, 40);
          text(rightscore, width-64, 40);
      }

      function keyReleased() {
          left.move(0);
          right.move(0);
      }

      function keyPressed() {
          console.log(key);
          // Convert to uppercase for consistent checking
          let upperKey = key.toUpperCase();
          
          if (upperKey == 'W') {
              left.move(-10);
          } else if (upperKey == 'S') {
              left.move(10);
          }

          if (upperKey == 'I') {
              right.move(-10);
          } else if (upperKey == 'K') {
              right.move(10);
          }
      }
    </script>
  </body>
</html>